<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>OrderBook</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../../../favicon.svg">
        <link rel="shortcut icon" href="../../../favicon.png">
        <link rel="stylesheet" href="../../../css/variables.css">
        <link rel="stylesheet" href="../../../css/general.css">
        <link rel="stylesheet" href="../../../css/chrome.css">
        <link rel="stylesheet" href="../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../highlight.css">
        <link rel="stylesheet" href="../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../book.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../../../index.html">Home</a></li><li class="chapter-item affix "><li class="part-title">src</li><li class="chapter-item "><a href="../../../src/abstract/index.html">❱ abstract</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/error.BadLender.html">BadLender</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/error.BadInitiator.html">BadInitiator</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/error.FlashLoanFailed.html">FlashLoanFailed</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/error.Initializing.html">Initializing</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/error.SwapFailed.html">SwapFailed</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/error.MinimumOutput.html">MinimumOutput</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/error.NonZeroBeforeArbStack.html">NonZeroBeforeArbStack</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/struct.OrderBookFlashBorrowerConfig.html">OrderBookFlashBorrowerConfig</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/abstract.OrderBookFlashBorrower.html">OrderBookFlashBorrower</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashBorrower.sol/constants.OrderBookFlashBorrower.html">OrderBookFlashBorrower constants</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashLender.sol/error.ZeroToken.html">ZeroToken</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashLender.sol/error.ZeroReceiver.html">ZeroReceiver</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashLender.sol/error.ZeroAmount.html">ZeroAmount</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashLender.sol/error.FlashLenderCallbackFailed.html">FlashLenderCallbackFailed</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashLender.sol/error.ActiveDebt.html">ActiveDebt</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashLender.sol/abstract.OrderBookFlashLender.html">OrderBookFlashLender</a></li><li class="chapter-item "><a href="../../../src/abstract/OrderBookFlashLender.sol/constants.OrderBookFlashLender.html">OrderBookFlashLender constants</a></li></ol></li><li class="chapter-item expanded "><a href="../../../src/concrete/index.html">❱ concrete</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../src/concrete/GenericPoolOrderBookFlashBorrower.sol/contract.GenericPoolOrderBookFlashBorrower.html">GenericPoolOrderBookFlashBorrower</a></li><li class="chapter-item "><a href="../../../src/concrete/GenericPoolOrderBookFlashBorrower.sol/constants.GenericPoolOrderBookFlashBorrower.html">GenericPoolOrderBookFlashBorrower constants</a></li><li class="chapter-item "><a href="../../../src/concrete/OrderBook.sol/error.ReentrancyGuardReentrantCall.html">ReentrancyGuardReentrantCall</a></li><li class="chapter-item "><a href="../../../src/concrete/OrderBook.sol/error.NotOrderOwner.html">NotOrderOwner</a></li><li class="chapter-item "><a href="../../../src/concrete/OrderBook.sol/error.TokenMismatch.html">TokenMismatch</a></li><li class="chapter-item "><a href="../../../src/concrete/OrderBook.sol/error.MinimumInput.html">MinimumInput</a></li><li class="chapter-item "><a href="../../../src/concrete/OrderBook.sol/error.SameOwner.html">SameOwner</a></li><li class="chapter-item expanded "><a href="../../../src/concrete/OrderBook.sol/contract.OrderBook.html" class="active">OrderBook</a></li><li class="chapter-item "><a href="../../../src/concrete/OrderBook.sol/constants.OrderBook.html">OrderBook constants</a></li></ol></li><li class="chapter-item "><a href="../../../src/interface/index.html">❱ interface</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../src/interface/deprecated/index.html">❱ deprecated</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/struct.DepositConfig.html">DepositConfig</a></li><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/struct.WithdrawConfig.html">WithdrawConfig</a></li><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/struct.IO.html">IO</a></li><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/struct.OrderConfig.html">OrderConfig</a></li><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/struct.Order.html">Order</a></li><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/struct.TakeOrdersConfig.html">TakeOrdersConfig</a></li><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/struct.TakeOrderConfig.html">TakeOrderConfig</a></li><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/struct.ClearConfig.html">ClearConfig</a></li><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/struct.ClearStateChange.html">ClearStateChange</a></li><li class="chapter-item "><a href="../../../src/interface/deprecated/IOrderBookV1.sol/interface.IOrderBookV1.html">IOrderBookV1</a></li></ol></li><li class="chapter-item "><a href="../../../src/interface/ierc3156/index.html">❱ ierc3156</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../src/interface/ierc3156/IERC3156FlashBorrower.sol/interface.IERC3156FlashBorrower.html">IERC3156FlashBorrower</a></li><li class="chapter-item "><a href="../../../src/interface/ierc3156/IERC3156FlashBorrower.sol/constants.IERC3156FlashBorrower.html">IERC3156FlashBorrower constants</a></li><li class="chapter-item "><a href="../../../src/interface/ierc3156/IERC3156FlashLender.sol/interface.IERC3156FlashLender.html">IERC3156FlashLender</a></li></ol></li><li class="chapter-item "><a href="../../../src/interface/unstable/index.html">❱ unstable</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../src/interface/unstable/IOrderBookV3.sol/struct.IO.html">IO</a></li><li class="chapter-item "><a href="../../../src/interface/unstable/IOrderBookV3.sol/struct.OrderConfig.html">OrderConfig</a></li><li class="chapter-item "><a href="../../../src/interface/unstable/IOrderBookV3.sol/struct.Order.html">Order</a></li><li class="chapter-item "><a href="../../../src/interface/unstable/IOrderBookV3.sol/struct.TakeOrdersConfig.html">TakeOrdersConfig</a></li><li class="chapter-item "><a href="../../../src/interface/unstable/IOrderBookV3.sol/struct.TakeOrderConfig.html">TakeOrderConfig</a></li><li class="chapter-item "><a href="../../../src/interface/unstable/IOrderBookV3.sol/struct.ClearConfig.html">ClearConfig</a></li><li class="chapter-item "><a href="../../../src/interface/unstable/IOrderBookV3.sol/struct.ClearStateChange.html">ClearStateChange</a></li><li class="chapter-item "><a href="../../../src/interface/unstable/IOrderBookV3.sol/interface.IOrderBookV3.html">IOrderBookV3</a></li></ol></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/struct.DepositConfig.html">DepositConfig</a></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/struct.WithdrawConfig.html">WithdrawConfig</a></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/struct.IO.html">IO</a></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/struct.OrderConfig.html">OrderConfig</a></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/struct.Order.html">Order</a></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/struct.TakeOrdersConfig.html">TakeOrdersConfig</a></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/struct.TakeOrderConfig.html">TakeOrderConfig</a></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/struct.ClearConfig.html">ClearConfig</a></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/struct.ClearStateChange.html">ClearStateChange</a></li><li class="chapter-item "><a href="../../../src/interface/IOrderBookV2.sol/interface.IOrderBookV2.html">IOrderBookV2</a></li></ol></li><li class="chapter-item "><a href="../../../src/lib/index.html">❱ lib</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../../../src/lib/LibOrder.sol/library.LibOrder.html">LibOrder</a></li><li class="chapter-item "><a href="../../../src/lib/LibOrderBook.sol/struct.OrderIOCalculation.html">OrderIOCalculation</a></li><li class="chapter-item "><a href="../../../src/lib/LibOrderBook.sol/library.LibOrderBook.html">LibOrderBook</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/rainprotocol/rain.orderbook" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="orderbook"><a class="header" href="#orderbook">OrderBook</a></h1>
<p><a href="https://github.com/rainprotocol/rain.orderbook/blob/bc1ef8bda6d1f1c6857ff284f17d6369cd1c4dbe/src/concrete/OrderBook.sol">Git Source</a></p>
<p><strong>Inherits:</strong>
<a href="/src/interface/unstable/IOrderBookV3.sol/interface.IOrderBookV3.html">IOrderBookV3</a>, ReentrancyGuard, Multicall, <a href="/src/abstract/OrderBookFlashLender.sol/abstract.OrderBookFlashLender.html">OrderBookFlashLender</a>, DeployerDiscoverableMetaV1</p>
<h2 id="state-variables"><a class="header" href="#state-variables">State Variables</a></h2>
<h3 id="sorders"><a class="header" href="#sorders">sOrders</a></h3>
<p>All hashes of all active orders. There's nothing interesting in the value
it's just nonzero if the order is live. The key is the hash of the order.
Removing an order sets the value back to zero so it is identical to the
order never existing and gives a gas refund on removal.
The order hash includes its owner so there's no need to build a multi
level mapping, each order hash MUST uniquely identify the order globally.
order hash =&gt; order is live</p>
<pre><code class="language-solidity">mapping(uint256 =&gt; uint256) internal sOrders;
</code></pre>
<h3 id="svaultbalances"><a class="header" href="#svaultbalances">sVaultBalances</a></h3>
<p><em>Vault balances are stored in a mapping of owner =&gt; token =&gt; vault ID
This gives 1:1 parity with the <code>IOrderBookV1</code> interface but keeping the
<code>sFoo</code> naming convention for storage variables.</em></p>
<pre><code class="language-solidity">mapping(address =&gt; mapping(address =&gt; mapping(uint256 =&gt; uint256))) internal sVaultBalances;
</code></pre>
<h2 id="functions"><a class="header" href="#functions">Functions</a></h2>
<h3 id="constructor"><a class="header" href="#constructor">constructor</a></h3>
<p>Initializes the orderbook upon construction for compatibility with
Open Zeppelin upgradeable contracts. Orderbook itself does NOT support
factory deployments as each order is a unique expression deployment
rather than needing to wrap up expressions with proxies.</p>
<pre><code class="language-solidity">constructor(DeployerDiscoverableMetaV1ConstructionConfig memory config)
    DeployerDiscoverableMetaV1(CALLER_META_HASH, config);
</code></pre>
<h3 id="nonreentrantview"><a class="header" href="#nonreentrantview">nonReentrantView</a></h3>
<p>Guard against read-only reentrancy.
https://chainsecurity.com/heartbreaks-curve-lp-oracles/</p>
<pre><code class="language-solidity">modifier nonReentrantView();
</code></pre>
<h3 id="vaultbalance"><a class="header" href="#vaultbalance">vaultBalance</a></h3>
<p>Get the current balance of a vault for a given owner, token and vault ID.</p>
<pre><code class="language-solidity">function vaultBalance(address owner, address token, uint256 vaultId)
    external
    view
    override
    nonReentrantView
    returns (uint256);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>owner</code></td><td><code>address</code></td><td>The owner of the vault.</td></tr>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token the vault is for.</td></tr>
<tr><td><code>vaultId</code></td><td><code>uint256</code></td><td></td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>&lt;none&gt;</code></td><td><code>uint256</code></td><td>balance The current balance of the vault.</td></tr>
</tbody></table>
</div>
<h3 id="deposit"><a class="header" href="#deposit">deposit</a></h3>
<p><code>msg.sender</code> deposits tokens according to config. The config specifies
the vault to deposit tokens under. Delegated depositing is NOT supported.
Depositing DOES NOT mint shares (unlike ERC4626) so the overall vaulted
experience is much simpler as there is always a 1:1 relationship between
deposited assets and vault balances globally and individually. This
mitigates rounding/dust issues, speculative behaviour on derived assets,
possible regulatory issues re: whether a vault share is a security, code
bloat on the vault, complex mint/deposit/withdraw/redeem 4-way logic,
the need for preview functions, etc. etc.
At the same time, allowing vault IDs to be specified by the depositor
allows much more granular and direct control over token movements within
Orderbook than either ERC4626 vault shares or mere contract-level ERC20
allowances can facilitate.
Vault IDs are namespaced by the token address so there is no risk of
collision between tokens. For example, vault ID 0 for token A is
completely different to vault ID 0 for token B.
<code>0</code> amount deposits are unsupported as underlying token contracts
handle <code>0</code> value transfers differently and this would be a source of
confusion. The order book MUST revert with <code>ZeroDepositAmount</code> if the
amount is zero.</p>
<pre><code class="language-solidity">function deposit(address token, uint256 vaultId, uint256 amount) external nonReentrant;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token to deposit.</td></tr>
<tr><td><code>vaultId</code></td><td><code>uint256</code></td><td>The vault ID to deposit under.</td></tr>
<tr><td><code>amount</code></td><td><code>uint256</code></td><td>The amount of tokens to deposit.</td></tr>
</tbody></table>
</div>
<h3 id="withdraw"><a class="header" href="#withdraw">withdraw</a></h3>
<p>Allows the sender to withdraw any tokens from their own vaults. If the
withrawer has an active flash loan debt denominated in the same token
being withdrawn then Orderbook will merely reduce the debt and NOT send
the amount of tokens repaid to the flashloan debt.</p>
<pre><code class="language-solidity">function withdraw(address token, uint256 vaultId, uint256 targetAmount) external nonReentrant;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>token</code></td><td><code>address</code></td><td>The token to withdraw.</td></tr>
<tr><td><code>vaultId</code></td><td><code>uint256</code></td><td>The vault ID to withdraw from.</td></tr>
<tr><td><code>targetAmount</code></td><td><code>uint256</code></td><td>The amount of tokens to attempt to withdraw. MAY result in fewer tokens withdrawn if the vault balance is lower than the target amount. MAY NOT be zero, the order book MUST revert with <code>ZeroWithdrawTargetAmount</code> if the amount is zero.</td></tr>
</tbody></table>
</div>
<h3 id="addorder"><a class="header" href="#addorder">addOrder</a></h3>
<p>Given an order config, deploys the expression and builds the full <code>Order</code>
for the config, then records it as an active order. Delegated adding an
order is NOT supported. The <code>msg.sender</code> that adds an order is ALWAYS
the owner and all resulting vault movements are their own.</p>
<pre><code class="language-solidity">function addOrder(OrderConfig calldata config) external nonReentrant;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>config</code></td><td><code>OrderConfig</code></td><td>All config required to build an <code>Order</code>.</td></tr>
</tbody></table>
</div>
<h3 id="_calculateorderdispatch"><a class="header" href="#_calculateorderdispatch">_calculateOrderDispatch</a></h3>
<pre><code class="language-solidity">function _calculateOrderDispatch(address expression_) internal pure returns (EncodedDispatch);
</code></pre>
<h3 id="_handleiodispatch"><a class="header" href="#_handleiodispatch">_handleIODispatch</a></h3>
<pre><code class="language-solidity">function _handleIODispatch(address expression_) internal pure returns (EncodedDispatch);
</code></pre>
<h3 id="removeorder"><a class="header" href="#removeorder">removeOrder</a></h3>
<p>Order owner can remove their own orders. Delegated order removal is NOT
supported and will revert. Removing an order multiple times or removing
an order that never existed are valid, the event will be emitted and the
transaction will complete with that order hash definitely, redundantly
not live.</p>
<pre><code class="language-solidity">function removeOrder(Order calldata order_) external nonReentrant;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>order_</code></td><td><code>Order</code></td><td></td></tr>
</tbody></table>
</div>
<h3 id="takeorders"><a class="header" href="#takeorders">takeOrders</a></h3>
<p>Allows <code>msg.sender</code> to attempt to fill a list of orders in sequence
without needing to place their own order and clear them. This works like
a market buy but against a specific set of orders. Every order will
looped over and calculated individually then filled maximally until the
request input is reached for the <code>msg.sender</code>. The <code>msg.sender</code> is
responsible for selecting the best orders at the time according to their
criteria and MAY specify a maximum IO ratio to guard against an order
spiking the ratio beyond what the <code>msg.sender</code> expected and is
comfortable with. As orders may be removed and calculate their ratios
dynamically, all issues fulfilling an order other than misconfiguration
by the <code>msg.sender</code> are no-ops and DO NOT revert the transaction. This
allows the <code>msg.sender</code> to optimistically provide a list of orders that
they aren't sure will completely fill at a good price, and fallback to
more reliable orders further down their list. Misconfiguration such as
token mismatches are errors that revert as this is known and static at
all times to the <code>msg.sender</code> so MUST be provided correctly. <code>msg.sender</code>
MAY specify a minimum input that MUST be reached across all orders in the
list, otherwise the transaction will revert, this MAY be set to zero.
Exactly like withdraw, if there is an active flash loan for <code>msg.sender</code>
they will have their outstanding loan reduced by the final input amount
preferentially before sending any tokens. Notably this allows arb bots
implemented as flash loan borrowers to connect orders against external
liquidity directly by paying back the loan with a <code>takeOrders</code> call and
outputting the result of the external trade.
Rounding errors always favour the order never the <code>msg.sender</code>.</p>
<pre><code class="language-solidity">function takeOrders(TakeOrdersConfig calldata takeOrders_)
    external
    nonReentrant
    returns (uint256 totalInput_, uint256 totalOutput_);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>takeOrders_</code></td><td><code>TakeOrdersConfig</code></td><td></td></tr>
</tbody></table>
</div>
<p><strong>Returns</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>totalInput_</code></td><td><code>uint256</code></td><td>totalInput Total tokens sent to <code>msg.sender</code>, taken from order vaults processed.</td></tr>
<tr><td><code>totalOutput_</code></td><td><code>uint256</code></td><td>totalOutput Total tokens taken from <code>msg.sender</code> and distributed between vaults.</td></tr>
</tbody></table>
</div>
<h3 id="clear"><a class="header" href="#clear">clear</a></h3>
<p>Allows <code>msg.sender</code> to match two live orders placed earlier by
non-interactive parties and claim a bounty in the process. The clearer is
free to select any two live orders on the order book for matching and as
long as they have compatible tokens, ratios and amounts, the orders will
clear. Clearing the orders DOES NOT remove them from the orderbook, they
remain live until explicitly removed by their owner. Even if the input
vault balances are completely emptied, the orders remain live until
removed. This allows order owners to deploy a strategy over a long period
of time and periodically top up the input vaults. Clearing two orders
from the same owner is disallowed.
Any mismatch in the ratios between the two orders will cause either more
inputs than there are available outputs (transaction will revert) or less
inputs than there are available outputs. In the latter case the excess
outputs are given to the <code>msg.sender</code> of clear, to the vaults they
specify in the clear config. This not only incentivises &quot;automatic&quot; clear
calls for both alice and bob, but incentivises <em>prioritising greater
ratio differences</em> with a larger bounty. The second point is important
because it implicitly prioritises orders that are further from the
current market price, thus putting constant increasing pressure on the
entire system the further it drifts from the norm, no matter how esoteric
the individual order expressions and sizings might be.
All else equal there are several factors that would impact how reliably
some order clears relative to the wider market, such as:</p>
<ul>
<li>Bounties are effectively percentages of cleared amounts so larger
orders have larger bounties and cover gas costs more easily</li>
<li>High gas on the network means that orders are harder to clear
profitably so the negative spread of the ratios will need to be larger</li>
<li>Complex and stateful expressions cost more gas to evalulate so the
negative spread will need to be larger</li>
<li>Erratic behavior of the order owner could reduce the willingness of
third parties to interact if it could result in wasted gas due to
orders suddently being removed before clearance etc.</li>
<li>Dynamic and highly volatile words used in the expression could be
ignored or low priority by clearers who want to be sure that they can
accurately predict the ratios that they include in their clearance</li>
<li>Geopolitical issues such as sanctions and regulatory restrictions could
cause issues for certain owners and clearers</li>
</ul>
<pre><code class="language-solidity">function clear(
    Order memory alice_,
    Order memory bob_,
    ClearConfig calldata clearConfig_,
    SignedContextV1[] memory aliceSignedContext_,
    SignedContextV1[] memory bobSignedContext_
) external nonReentrant;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>alice_</code></td><td><code>Order</code></td><td></td></tr>
<tr><td><code>bob_</code></td><td><code>Order</code></td><td></td></tr>
<tr><td><code>clearConfig_</code></td><td><code>ClearConfig</code></td><td></td></tr>
<tr><td><code>aliceSignedContext_</code></td><td><code>SignedContextV1[]</code></td><td></td></tr>
<tr><td><code>bobSignedContext_</code></td><td><code>SignedContextV1[]</code></td><td></td></tr>
</tbody></table>
</div>
<h3 id="_calculateorderio"><a class="header" href="#_calculateorderio">_calculateOrderIO</a></h3>
<p>Main entrypoint into an order calculates the amount and IO ratio. Both
are always treated as 18 decimal fixed point values and then rescaled
according to the order's definition of each token's actual fixed point
decimals.</p>
<pre><code class="language-solidity">function _calculateOrderIO(
    Order memory order,
    uint256 inputIOIndex,
    uint256 outputIOIndex,
    address counterparty,
    SignedContextV1[] memory signedContext
) internal view virtual returns (OrderIOCalculation memory);
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>order</code></td><td><code>Order</code></td><td>The order to evaluate.</td></tr>
<tr><td><code>inputIOIndex</code></td><td><code>uint256</code></td><td>The index of the input token being calculated for.</td></tr>
<tr><td><code>outputIOIndex</code></td><td><code>uint256</code></td><td>The index of the output token being calculated for.</td></tr>
<tr><td><code>counterparty</code></td><td><code>address</code></td><td>The counterparty of the order as it is currently being cleared against.</td></tr>
<tr><td><code>signedContext</code></td><td><code>SignedContextV1[]</code></td><td>Any signed context provided by the clearer/taker that the order may need for its calculations.</td></tr>
</tbody></table>
</div>
<h3 id="_recordvaultio"><a class="header" href="#_recordvaultio">_recordVaultIO</a></h3>
<p>Given an order, final input and output amounts and the IO calculation
verbatim from <code>_calculateOrderIO</code>, dispatch the handle IO entrypoint if
it exists and update the order owner's vault balances.</p>
<pre><code class="language-solidity">function _recordVaultIO(Order memory order, uint256 input, uint256 output, OrderIOCalculation memory orderIOCalculation)
    internal
    virtual;
</code></pre>
<p><strong>Parameters</strong></p>
<div class="table-wrapper"><table><thead><tr><th>Name</th><th>Type</th><th>Description</th></tr></thead><tbody>
<tr><td><code>order</code></td><td><code>Order</code></td><td>The order that is being cleared.</td></tr>
<tr><td><code>input</code></td><td><code>uint256</code></td><td>The exact token input amount to move into the owner's vault.</td></tr>
<tr><td><code>output</code></td><td><code>uint256</code></td><td>The exact token output amount to move out of the owner's vault.</td></tr>
<tr><td><code>orderIOCalculation</code></td><td><code>OrderIOCalculation</code></td><td>The verbatim order IO calculation returned by <code>_calculateOrderIO</code>.</td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../src/concrete/OrderBook.sol/error.SameOwner.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../src/concrete/OrderBook.sol/constants.OrderBook.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../src/concrete/OrderBook.sol/error.SameOwner.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../src/concrete/OrderBook.sol/constants.OrderBook.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../elasticlunr.min.js"></script>
        <script src="../../../mark.min.js"></script>
        <script src="../../../searcher.js"></script>

        <script src="../../../clipboard.min.js"></script>
        <script src="../../../highlight.js"></script>
        <script src="../../../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../../solidity.min.js"></script>


    </div>
    </body>
</html>
